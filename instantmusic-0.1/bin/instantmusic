#!/usr/bin/env python

import os
import glob
from array import *
from bs4 import BeautifulSoup

# Version compatiblity
import sys
if (sys.version_info > (3,0)):
    from urllib.request import urlopen
    from urllib.parse import quote_plus as qp
    raw_input = input
else:
    from urllib2 import urlopen
    from urllib import quote_plus as qp

video_link_set = set([])
search = ''
# We do not want to accept empty inputs :)
while search == '':
  search = raw_input('Enter songname/ lyrics/ artist.. or whatever\n> ')
search = qp(search)

print('Making a Query Request! ')

# Magic happens here.
response = urlopen('https://www.youtube.com/results?search_query=' + search)
html = response.read()
soup = BeautifulSoup(html, 'html.parser')
for link in soup.find_all('a'):
    if '/watch?v=' in link.get('href'):
        # May change when Youtube gets updated in the future.
        video_link = link.get('href')
        tag = soup.find("a", {"class" :"yt-uix-tile-link", "href" : video_link })
        if str(tag) != "None":
            title = tag.text
            video_link_set.add(video_link + ":" + title)

size_of_videos = len(video_link_set)
video_link_list = list(video_link_set)
if size_of_videos > 0:
    for idx, value in enumerate(video_link_list):
        print('(' + str(idx + 1) + ')' +  ' ' + value.split(':')[1])

    prompt = raw_input("\nPlease enter song number from  (1-" + str(size_of_videos) + ") to download : ")

    if prompt.isdigit():
        song_number = int(prompt)
        if song_number >= 1 and song_number <= size_of_videos:
            # Links are relative on page, making them absolute.
            video_link = 'http://www.youtube.com/' + video_link_list[song_number - 1].split(':')[0]
            command = 'youtube-dl --extract-audio --audio-format mp3 --audio-quality 0 ' + video_link

            # Youtube-dl is a proof that god exists.
            print ('Downloading...')
            os.system(command)
        else:
            print ('Invalid song selected!!')
            sys.exit()
    else:
        print ('Invalid value entered!!')
        sys.exit()
else:
    print('No results were found. Please modify your search query!!')
